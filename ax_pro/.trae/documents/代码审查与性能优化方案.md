## 项目现状概览
- 技术栈：Spring Boot 3.2、Java 17、Sa-Token、Redis、H2/MySQL（可切换）
- 结构：`controller`、`service`、`rule`、`dto`、`config` 清晰；REST API 前缀 `/api`
- 发现问题：响应不统一、异常处理缺失、部分校验不足、`submit` 仅登录校验、规则引擎可测试性弱、选项/结果查询存在性能隐患、Redis 异常被吞、构建与配置存在小风险（数据源驱动、Redis属性、冗余依赖）

## 优化目标
- 统一响应与错误语义，完善参数校验与异常处理
- 加固安全（令牌传输、拦截策略、CORS/CSRF）
- 消除 N+1 与线性查找，提升服务层性能与可测试性
- 增强观测性（日志、统计），规范配置与依赖管理
- 完成端到端回归测试与关键单元测试

## 高优先级改动（按影响与收益排序）
1. 新增全局异常处理：`GlobalExceptionHandler`（`@ControllerAdvice`）统一 400/404/500 与业务异常响应
2. 统一响应封装：新增通用 `ApiResponse<T>`；控制器使用 `ResponseEntity<ApiResponse<?>>`
3. 控制器校验与空值处理：
   - `TestController`: `@Positive Long id`、`getTest(id)` 判空返回 404；`submit` 校验答案是否属于该测评
   - `AuthController`: 去除硬编码账号，预留认证服务接口；失败返回标准错误体并记录审计日志
4. 服务层性能优化：
   - `TestService`: 提供一次性加载选项的接口（如 `Map<Long, Option> listOptionsByTest(Long testId)`）；提供 `Optional<TestResult> findResultByCode(...)`
   - `ScoringService`: 构造注入 `RuleEngine`；使用批量选项映射；对无匹配结果给出明确语义
5. 规则引擎可测试性：将 `RuleEngine` 声明为 Spring Bean（`@Component`），移除手动 `new`
6. 统计与日志：`StatsService` 捕获异常时记录 `warn` 日志，抽取 Redis 键前缀常量，避免吞异常
7. 安全与拦截：
   - Sa-Token 仅读白名单，所有写接口统一 `checkLogin`；`setError(...)` 返回标准错误结构
   - 切换为 Header-only 令牌：`is-read-head: true`、`is-read-cookie: false`；缩短 `timeout` 并启用 `activity-timeout`
   - 全局 CORS：限定可信来源、方法与头部；处理预检请求
8. 配置与依赖：
   - `application.yml` 删除或参数化 `driver-class-name`（允许 MySQL 自动推断）
   - 移除冗余 `jackson-databind`；校正 Redis 连接池属性为受支持键
   - 视需要拆分 `application-dev.yml` / `application-prod.yml`

## 实施步骤
### 控制器与响应规范
- 新增 `ApiResponse` 与 `GlobalExceptionHandler`
- 重构 `AuthController.login`、`TestController.detail/submit/result` 的返回为统一响应；补足 `id` 与输入校验

### 校验与异常
- DTO 增强：`@Positive`、`@Size` 等边界校验
- 服务层对空集合/空对象抛业务异常，控制器转换为对应 HTTP 状态

### 服务与性能
- 在 `TestService` 增加批量选项与结果索引方法；`ScoringService` 使用映射避免 N+1；`result` 查询改为索引查询

### 安全与配置
- Sa-Token 过滤器改为白名单放行只读接口；写接口统一鉴权
- 配置令牌仅从 Header 读取并调整超时策略；新增全局 CORS 配置

### Redis 与观测性
- `StatsService` 记录失败日志、抽取键常量；考虑限流/降级策略（预留）

### 构建与环境
- `pom.xml` 精简依赖（移除显式 Jackson）；`application.yml` 修正数据源与 Redis 属性；按环境拆分 profile（可选）

### 测试与验证
- 单元测试：`RuleEngine`、`ScoringService`（含边界与异常）
- 控制器集成测试（MockMvc）：匿名访问、登录后提交、错误请求断言
- 流程回归：`GET /api/tests`→`GET /api/tests/{id}`→`POST /api/tests/{id}/submit`（含未登录/已登录）→`GET /api/tests/{id}/result/{code}`；验证 PV/UV

## 风险与兼容性
- 令牌读取策略改变需前端配合（改用请求头）
- 结果索引与选项映射引入内存结构，应评估数据规模
- H2/MySQL 切换时驱动与 SQL 方言需一致；建议分环境配置

## 交付清单（示例）
- 新增：`GlobalExceptionHandler.java`、`ApiResponse.java`
- 修改：`AuthController.java`、`TestController.java`、`TestService.java`、`ScoringService.java`、`RuleEngine.java`、`StatsService.java`、`SaTokenConfig.java`、`application.yml`、`pom.xml`
- 新增测试：`RuleEngineTest`、`ScoringServiceTest`、`AuthControllerTest`、`TestControllerTest`

如确认上述方案，我将按“高优先级改动”自上而下实施，并在每一步完成后进行测试与回归验证。