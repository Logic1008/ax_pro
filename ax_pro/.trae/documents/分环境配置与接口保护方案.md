## 分环境配置
- 新增 `src/main/resources/application-dev.yml`：使用 H2 内存库、`REDIS_HOST: localhost`、开发用 Actuator 暴露更多端点
- 新增 `src/main/resources/application-prod.yml`：使用 MySQL（从环境变量读取 URL/用户/密码，移除固定驱动）、生产 Redis、限制 Actuator 端点
- 选择配置：通过环境变量 `SPRING_PROFILES_ACTIVE` 指定 `dev` 或 `prod`，默认保持 `application.yml` 为公共基线

## 生产配置建议（示例）
- `application-prod.yml`
  - `spring.datasource.url: ${DB_URL}`、`spring.datasource.username: ${DB_USER}`、`spring.datasource.password: ${DB_PASS}`
  - `spring.sql.init.mode: never`
  - `spring.data.redis.host: ${REDIS_HOST}`、`spring.data.redis.port: ${REDIS_PORT}`
  - `management.endpoints.web.exposure.include: health,metrics,info,prometheus`
  - `resilience4j.rateLimiter.instances.tests-submit-rl`: `limitForPeriod: 50`、`limitRefreshPeriod: 1s`、`timeoutDuration: 0`
  - `resilience4j.circuitbreaker.instances.redis`: `failureRateThreshold: 50`、`slidingWindowSize: 50`、`waitDurationInOpenState: 30s`
  - `resilience4j.circuitbreaker.instances.scoring`: 同上，按业务期望微调

- `application-dev.yml`
  - `spring.datasource.url: jdbc:h2:mem:ax_pro;MODE=MySQL;DB_CLOSE_DELAY=-1;DATABASE_TO_UPPER=false`
  - `spring.data.redis.host: localhost`、`spring.data.redis.port: 6379`
  - `management.endpoints.web.exposure.include: health,metrics,info`
  - 保留当前 Sa-Token、CORS 的基线配置

## 依赖与框架
- 引入 `resilience4j-spring-boot3` 以启用 `@RateLimiter`、`@CircuitBreaker`、配置化限流/熔断
- 引入 `spring-boot-starter-actuator` 与 Micrometer（随 Web Starter），用于指标暴露与健康检查
- 若需 Prometheus，后续可加 `micrometer-registry-prometheus`

## 接口限流与熔断
- 控制器方法：
  - 在 `TestController.submit` 增加 `@RateLimiter(name = "tests-submit-rl")`
  - 如需更细粒度，可对 `detail` 增加只读限流 `@RateLimiter(name = "tests-detail-rl")`
- 服务层：
  - 在 `StatsService.incrPv`/`recordUv` 增加 `@CircuitBreaker(name = "redis", fallbackMethod = "redisFallback")`
  - 在 `ScoringService.score` 增加 `@CircuitBreaker(name = "scoring")`
- 全局异常处理：在 `GlobalExceptionHandler` 增加对 `io.github.resilience4j.ratelimiter.RequestNotPermitted` 的处理，返回 `429` 与标准错误体

## 监控埋点
- Actuator：开启 `health`、`metrics`、`prometheus`（生产），用于与监控系统集成
- Micrometer 注解：
  - 在 `TestController.submit`、`detail` 添加 `@io.micrometer.core.annotation.Timed(value = "api.tests.submit")`、`@Timed("api.tests.detail")`
- 业务指标：
  - 在 `StatsService` 记录失败计数器 `metrics.counter("stats.redis.fail").increment()`
  - 在 `ScoringService.score` 使用 `Timer` 计时评分过程 `metrics.timer("scoring.time").record(...)`

## 代码改动清单
- 新增文件：`application-dev.yml`、`application-prod.yml`
- 依赖：`pom.xml` 添加 `spring-boot-starter-actuator`、`resilience4j-spring-boot3`
- 控制器：`TestController.submit` 增加 `@RateLimiter` 与 `@Timed`
- 服务：`StatsService` 与 `ScoringService` 增加 `@CircuitBreaker`，`StatsService` 增加降级方法；埋点计数与计时
- 异常：`GlobalExceptionHandler` 增加 `RequestNotPermitted`→`429` 的处理

## 验证与测试
- 集成测试：
  - `SPRING_PROFILES_ACTIVE=dev` 下运行现有用例（基础功能应通过）
  - 增加限流触发测试：快速并发请求 `POST /api/tests/{id}/submit` 断言返回 `429`
  - 熔断测试：模拟 Redis 抛错，断言走降级不影响主流程（PV/UV 无异常）
- 指标验证：
  - 启动后访问 `/actuator/metrics` 与 `/actuator/prometheus`（prod）确认自定义指标存在

## 风险与回滚
- 限流策略需与前端/网关策略协调，避免双重限流；初期限流值偏保守，后续按流量调优
- 熔断与降级可能影响统计准确性；对关键数据链路保留告警与监控
- 生产启用 Actuator 时注意端点保护与网络隔离

## 交付与启用
- 提交以上改动后，在生产环境设置：
  - `SPRING_PROFILES_ACTIVE=prod`
  - `DB_URL/DB_USER/DB_PASS` 与 `REDIS_HOST/REDIS_PORT`
- 验证各端点与指标暴露，观察监控与日志，按需调参限流/熔断阈值