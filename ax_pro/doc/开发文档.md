# 开发文档

## 项目概览
- 技术栈：Java 17、Spring Boot 3.2、Sa-Token、Redis、H2/MySQL、Resilience4j、Actuator、Micrometer
- 模块：`controller`、`service`、`rule`、`dto`、`config`、`common`
- API 前缀：`/api`

## 运行环境与配置
- 分环境：
  - 开发：`SPRING_PROFILES_ACTIVE=dev`，使用 H2 内存库与本地 Redis
  - 生产：`SPRING_PROFILES_ACTIVE=prod`，使用 MySQL 与生产 Redis
- 关键环境变量：
  - 数据库：`DB_URL`、`DB_USER`、`DB_PASS`
  - Redis：`REDIS_HOST`、`REDIS_PORT`
- 认证令牌：仅从请求头读取，名称为 `token`；`timeout=7d`，`activity-timeout=30m`，`token-style=uuid`

## 数据库设计
表结构（见 `src/main/resources/schema.sql`）：
- `personality_test`
  - `id BIGINT PK`、`code VARCHAR(64)`、`name VARCHAR(255)`、`description TEXT`
  - `rule_type VARCHAR(64)`、`rule_config TEXT`
- `question`
  - `id BIGINT PK`、`test_id BIGINT`、`code VARCHAR(64)`、`text VARCHAR(500)`、`dimension VARCHAR(64)`
- `option_item`
  - `id BIGINT PK`、`question_id BIGINT`、`text VARCHAR(500)`、`value_map TEXT`（JSON，示例：`{"EI": 1.0}`）
- `test_result`
  - `id BIGINT PK`、`test_id BIGINT`、`code VARCHAR(64)`、`name VARCHAR(255)`、`description TEXT`、`condition TEXT`（SpEL 条件）

初始化数据（见 `src/main/resources/data.sql`）：
- 示例测评 `MBTI`，两道题，四个选项，两条结果（条件基于 `EI` 与 `SN` 维度）

## Redis 键设计
- `test:pv:{testId}`：页面访问量（PV）
- `test:uv:{testId}`：唯一访客集合（UV，成员为 `userId`）
- `test:rank`：ZSet，成员 `testId`，score 为 PV 增量

## 接口文档（对接前端）
所有响应统一封装：
```
{
  "code": "OK|ERROR_CODE",
  "message": "success|错误描述",
  "data": { ... },
  "timestamp": 1730xxxxxxx
}
```

### 认证
- `POST /api/auth/login`
  - 入参：`{ "username": "string", "password": "string" }`
  - 成功：`{ "code": "OK", "data": { "token": "uuid" } }`
  - 失败：`401 { "code": "UNAUTHORIZED", "message": "invalid credentials" }`
  - 说明：当前示例账号 `test/123456`（生产需替换为真实用户系统）

### 测评列表
- `GET /api/tests`
  - 成功：`{ "code": "OK", "data": [ { "id": 1, "code": "MBTI", "name": "MBTI性格测试", ... } ] }`

### 测评详情
- `GET /api/tests/{id}`
  - 成功：
    ```
    {
      "code": "OK",
      "data": {
        "test": { "id": 1, "code": "MBTI", ... },
        "questions": [ { "id": 101, "code": "Q1", "dimension": "EI", ... }, ... ],
        "options": { "101": [ { "id": 1001, "text": "是", "valueMap": "{\"EI\":1.0}" }, ... ], ... }
      }
    }
    ```
  - 404：`{ "code": "NOT_FOUND", "message": "test not found" }`
  - 说明：该接口匿名可访问，限流名 `tests-detail-rl`

### 提交答案并返回结果代码
- `POST /api/tests/{id}/submit`
  - 需登录：请求头携带 `token: <uuid>`
  - 入参：`{ "answers": { "<questionId>": <optionId>, ... } }`
  - 成功：`{ "code": "OK", "data": { "resultCode": "E_S" } }`
  - 404：`{ "code": "NOT_FOUND", "message": "test not found" }`
  - 400：`{ "code": "BAD_REQUEST", "message": "answers required" }`
  - 401：`{ "code": "UNAUTHORIZED", "message": "login required" }`
  - 429（限流）：`{ "code": "TOO_MANY_REQUESTS", "message": "rate limit exceeded" }`
  - 说明：限流名 `tests-submit-rl`；成功时记录 PV 与在登录态下记录 UV

### 按结果代码查询详情
- `GET /api/tests/{id}/result/{code}`
  - 成功：`{ "code": "OK", "data": { "id": 3001, "code": "E_S", "name": "外向且偏实感", ... } }`
  - 404：`{ "code": "NOT_FOUND", "message": "result not found" }`
  - 说明：匿名可访问

## 接入示例
### 登录并提交
```
# 登录
POST /api/auth/login
Content-Type: application/json
{
  "username": "test",
  "password": "123456"
}

# 解析响应获取 token 后提交
POST /api/tests/1/submit
Content-Type: application/json
token: 3c2f07b7-...-...
{
  "answers": { "101": 1001, "102": 2001 }
}
```

### 获取列表与详情
```
GET /api/tests
GET /api/tests/1
```

## 监控与运维
- Actuator 端点（prod）：`/actuator/health`、`/actuator/metrics`、`/actuator/info`、`/actuator/prometheus`
- Micrometer 埋点：
  - 接口计时：`api.tests.list`、`api.tests.detail`、`api.tests.submit`
  - 评分计时：`scoring.time`
  - Redis 失败计数：`stats.redis.fail`
- Resilience4j：
  - 限流实例：`tests-submit-rl`、`tests-detail-rl`
  - 熔断实例：`redis`、`scoring`

## 需要接上的接口（前端对接清单）
- 已提供：
  - `POST /api/auth/login`
  - `GET /api/tests`
  - `GET /api/tests/{id}`
  - `POST /api/tests/{id}/submit`（需登录）
  - `GET /api/tests/{id}/result/{code}`
- 建议新增（未实现，供前端预留对接）：
  - 用户与认证
    - `POST /api/auth/register`：用户注册（密码哈希）
    - `POST /api/auth/logout`：退出登录
    - `GET /api/auth/profile`：当前用户信息
  - 测评管理（后台）
    - `GET /api/admin/tests`/`POST /api/admin/tests`：测评列表/新增
    - `PUT /api/admin/tests/{id}`/`DELETE /api/admin/tests/{id}`：更新/删除
    - `POST /api/admin/tests/{id}/questions`：新增题目
    - `POST /api/admin/questions/{id}/options`：新增选项
    - `POST /api/admin/tests/{id}/results`：新增结果规则
  - 统计与排行
    - `GET /api/tests/{id}/stats`：PV/UV 概览
    - `GET /api/tests/rank`：按 PV 排行
  - 系统与监控
    - `GET /api/system/version`：版本信息
    - `GET /actuator/*`：监控端点（仅生产与内网暴露）

## 后续重要未实现功能
- 用户体系：注册、密码哈希（BCrypt）、登录失败限流与锁定、审计日志
- 题库与规则持久化：从内存迁移到数据库，支持 CRUD 与版本化
- 答案合法性校验：校验题目与选项归属、缺失题目策略、重复作答规则
- 多测试类型完善：`RuleEngine` 扩展更多规则与校验、配置可视化
- 缓存与性能：选项/结果缓存、热点数据预载、批量统计写入
- 灰度与风控：接口限流细粒度、IP/设备识别、风险评分
- 监控与告警：异常趋势、限流/熔断触发率、PV/UV 异常波动告警
- 国际化与可访问性：文案多语言、接口错误码规范统一

## 启动与验证
- 开发：
  - 设置 `SPRING_PROFILES_ACTIVE=dev`
  - 启动后访问 `/api/tests`、`/api/tests/1` 验证数据；使用示例账号登录并提交验证评分
- 生产：
  - 设置数据库与 Redis 环境变量并 `SPRING_PROFILES_ACTIVE=prod`
  - 验证限流与熔断参数，检查 Actuator 指标与埋点是否可见

